<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>无IP文本互传（共享码版）</title>
    <style>
        body { max-width: 500px; margin: 20px auto; padding: 0 15px; font-family: sans-serif; }
        .container { margin: 25px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        h3 { margin-top: 0; color: #333; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #eee; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 140px; resize: none; }
        .btn { width: 100%; padding: 12px; margin: 10px 0; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        #receiveBox { background: #f8f9fa; }
        .tip { color: #7f8c8d; font-size: 14px; margin: 5px 0; }
        .success { color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>
    <h1>无IP文本互传</h1>

    <!-- 1. 共享码设置（唯一关键步骤） -->
    <div class="container">
        <h3>1. 设置共享码</h3>
        <input type="text" id="shareCode" placeholder="输入任意共享码（两台设备必须一样，如“abc123”）">
        <button class="btn" id="joinBtn">加入共享</button>
        <div class="tip" id="status">未加入共享 | 提示：两台设备输相同共享码即可</div>
    </div>

    <!-- 2. 发送文本 -->
    <div class="container">
        <h3>2. 发送文本</h3>
        <textarea id="sendText" placeholder="输入要发送的内容..." disabled></textarea>
        <button class="btn" id="sendBtn" disabled>发送</button>
    </div>

    <!-- 3. 接收文本 -->
    <div class="container" id="receiveBox">
        <h3>3. 接收文本</h3>
        <textarea id="receiveText" readonly placeholder="等待接收内容..."></textarea>
        <button class="btn" style="background: #e67e22;" id="clearBtn" disabled>清空接收区</button>
    </div>

    <script>
        // 核心逻辑：用“共享码+localStorage广播”，同一网络自动匹配
        let currentCode = '';
        let broadcastInterval; // 广播/监听定时器

        // DOM元素
        const shareCodeInput = document.getElementById('shareCode');
        const joinBtn = document.getElementById('joinBtn');
        const status = document.getElementById('status');
        const sendText = document.getElementById('sendText');
        const sendBtn = document.getElementById('sendBtn');
        const receiveText = document.getElementById('receiveText');
        const clearBtn = document.getElementById('clearBtn');

        // 1. 加入共享（输入共享码后启用功能）
        joinBtn.addEventListener('click', () => {
            currentCode = shareCodeInput.value.trim();
            if (!currentCode) {
                alert('请输入共享码（至少2个字符）');
                return;
            }

            // 启用发送/清空按钮
            sendText.disabled = false;
            sendBtn.disabled = false;
            clearBtn.disabled = false;
            status.innerHTML = `<span class="success">已加入共享：${currentCode}</span> | 可发送/接收文本`;

            // 启动“广播+监听”：每1秒同步一次文本
            startBroadcastAndListen();
        });

        // 2. 广播自己的文本 + 监听对方的文本
        function startBroadcastAndListen() {
            // 清除旧定时器（避免重复）
            if (broadcastInterval) clearInterval(broadcastInterval);

            broadcastInterval = setInterval(() => {
                // 1. 广播：把自己的发送记录存到localStorage（用共享码当key）
                const myText = receiveText.value;
                if (myText) {
                    localStorage.setItem(`share_${currentCode}`, myText);
                }

                // 2. 监听：读取对方存的文本，更新接收区
                const peerText = localStorage.getItem(`share_${currentCode}`);
                if (peerText && peerText !== receiveText.value) {
                    receiveText.value = peerText;
                    receiveText.scrollTop = receiveText.scrollHeight; // 滚动到底部
                }
            }, 1000); // 每秒同步一次，实时性足够
        }

        // 3. 发送文本
        sendBtn.addEventListener('click', () => {
            const text = sendText.value.trim();
            if (!text) return;

            // 拼接时间戳和文本，显示在接收区
            const time = new Date().toLocaleTimeString();
            const newContent = receiveText.value + `我(${time})：\n${text}\n\n`;
            
            // 更新接收区并广播
            receiveText.value = newContent;
            receiveText.scrollTop = receiveText.scrollHeight;
            localStorage.setItem(`share_${currentCode}`, newContent);

            // 清空输入框
            sendText.value = '';
        });

        // 4. 清空接收区
        clearBtn.addEventListener('click', () => {
            receiveText.value = '';
            localStorage.setItem(`share_${currentCode}`, '');
        });

        // 页面关闭时清除存储，避免残留
        window.addEventListener('beforeunload', () => {
            if (currentCode) {
                localStorage.removeItem(`share_${currentCode}`);
            }
        });
    </script>
</body>
</html>
