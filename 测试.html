<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC æ–‡æœ¬åŒæ­¥å·¥å…·</title>
    <style>
        body { max-width: 500px; margin: 20px auto; padding: 0 20px; font-family: sans-serif; }
        .container { margin: 15px 0; }
        input, textarea, button { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; }
        #status { color: #666; font-size: 0.9em; margin-top: 10px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h3>WebRTC è·¨è®¾å¤‡æ–‡æœ¬åŒæ­¥</h3>
    <!-- å–ä»¶ç åŒ¹é…åŒº -->
    <div class="container">
        <label>å–ä»¶ç ï¼ˆä¸¤å°è®¾å¤‡éœ€ä¸€è‡´ï¼‰ï¼š</label>
        <input type="text" id="code" placeholder="è¾“å…¥4ä½å–ä»¶ç " maxlength="4">
        <button onclick="initConnection()">å¼€å§‹è¿æ¥</button>
    </div>

    <!-- æ–‡æœ¬è¾“å…¥åŒº -->
    <div class="container">
        <label>è¾“å…¥æ–‡æœ¬ï¼š</label>
        <textarea id="sendText" rows="4" placeholder="è¾“å…¥è¦å‘é€çš„å†…å®¹..."></textarea>
        <button onclick="sendMessage()" disabled>å‘é€æ–‡æœ¬</button>
    </div>

    <!-- æ–‡æœ¬æ¥æ”¶åŒº -->
    <div class="container">
        <label>æ¥æ”¶çš„æ–‡æœ¬ï¼š</label>
        <textarea id="recvText" rows="4" readonly placeholder="ç­‰å¾…æ¥æ”¶å†…å®¹..."></textarea>
        <div id="status">æœªè¿æ¥ï¼Œè¯·è¾“å…¥å–ä»¶ç å¹¶ç‚¹å‡»ã€Œå¼€å§‹è¿æ¥ã€</div>
    </div>

    <script>
        let peerConnection;
        const codeInput = document.getElementById('code');
        const sendText = document.getElementById('sendText');
        const recvText = document.getElementById('recvText');
        const status = document.getElementById('status');
        const sendBtn = document.querySelector('button[onclick="sendMessage()"]');

        // åˆå§‹åŒ–WebRTCè¿æ¥
        function initConnection() {
            const code = codeInput.value.trim();
            if (!code) { 
                status.className = 'error';
                status.textContent = 'âŒ è¯·å…ˆè¾“å…¥å–ä»¶ç ';
                return; 
            }

            // é…ç½®WebRTCï¼ˆæ— éœ€æœåŠ¡å™¨ï¼Œä»…æœ¬åœ°ç½‘ç»œï¼‰
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            peerConnection = new RTCPeerConnection(config);
            sendBtn.disabled = true;
            status.className = 'success';
            status.textContent = 'ğŸ” æ­£åœ¨åŒä¸€ç½‘ç»œæœç´¢è®¾å¤‡...';

            // ç›‘å¬æ•°æ®é€šé“ï¼ˆæ¥æ”¶æ–¹ï¼‰
            peerConnection.ondatachannel = e => {
                const dataChannel = e.channel;
                dataChannel.onmessage = e => {
                    recvText.value = e.data;
                    status.textContent = `âœ… å·²æ¥æ”¶æ–‡æœ¬ï¼ˆ${new Date().toLocaleTimeString()}ï¼‰`;
                };
                dataChannel.onopen = () => {
                    sendBtn.disabled = false;
                    status.textContent = 'âœ… è®¾å¤‡å·²è¿æ¥ï¼Œå¯å‘é€æ–‡æœ¬';
                };
            };

            // ç›‘å¬ICEå€™é€‰ï¼ˆå»ºç«‹P2Pè¿æ¥ï¼‰
            peerConnection.onicecandidate = e => {
                if (e.candidate) {
                    // ç”¨å–ä»¶ç ä½œä¸ºkeyï¼Œå­˜å‚¨å€™é€‰ä¿¡æ¯åˆ°localStorageï¼ˆåŒä¸€ç½‘ç»œè®¾å¤‡å¯è¯»å–ï¼‰
                    localStorage.setItem(`webrtc_${code}`, JSON.stringify({
                        type: 'candidate',
                        data: e.candidate.toJSON()
                    }));
                }
            };

            // ä¸»åŠ¨åˆ›å»ºæ•°æ®é€šé“ï¼ˆå‘é€æ–¹ï¼‰
            const dataChannel = peerConnection.createDataChannel('textSync');
            dataChannel.onopen = () => {
                sendBtn.disabled = false;
                status.textContent = 'âœ… è®¾å¤‡å·²è¿æ¥ï¼Œå¯å‘é€æ–‡æœ¬';
            };
            dataChannel.onmessage = e => {
                recvText.value = e.data;
                status.textContent = `âœ… å·²æ¥æ”¶æ–‡æœ¬ï¼ˆ${new Date().toLocaleTimeString()}ï¼‰`;
            };

            // ç›‘å¬å¯¹æ–¹çš„è¿æ¥è¯·æ±‚ï¼ˆé€šè¿‡localStorageï¼‰
            setInterval(() => {
                const storedData = localStorage.getItem(`webrtc_${code}`);
                if (storedData) {
                    const { type, data } = JSON.parse(storedData);
                    if (type === 'offer') handleOffer(data);
                    if (type === 'candidate' && peerConnection) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(data))
                            .catch(err => console.error('æ·»åŠ å€™é€‰å¤±è´¥:', err));
                    }
                }
            }, 1000);

            // åˆ›å»ºå¹¶å‘é€è¿æ¥è¯·æ±‚ï¼ˆofferï¼‰
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    localStorage.setItem(`webrtc_${code}`, JSON.stringify({
                        type: 'offer',
                        data: peerConnection.localDescription.toJSON()
                    }));
                })
                .catch(err => {
                    status.className = 'error';
                    status.textContent = `âŒ è¿æ¥å¤±è´¥ï¼š${err.message}`;
                });
        }

        // å¤„ç†å¯¹æ–¹çš„è¿æ¥è¯·æ±‚ï¼ˆofferï¼‰
        function handleOffer(offerData) {
            if (!peerConnection) return;
            peerConnection.setRemoteDescription(new RTCSessionDescription(offerData))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    localStorage.setItem(`webrtc_${codeInput.value}`, JSON.stringify({
                        type: 'answer',
                        data: peerConnection.localDescription.toJSON()
                    }));
                })
                .catch(err => console.error('å¤„ç†offerå¤±è´¥:', err));
        }

        // å‘é€æ–‡æœ¬
        function sendMessage() {
            const text = sendText.value.trim();
            if (!text) return;
            const dataChannel = peerConnection.getSenders()[0].transport.datachannel;
            if (dataChannel.readyState === 'open') {
                dataChannel.send(text);
                sendText.value = '';
                status.textContent = `âœ… æ–‡æœ¬å·²å‘é€ï¼ˆ${new Date().toLocaleTimeString()}ï¼‰`;
            }
        }
    </script>
</body>
</html>
