<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同一WiFi文本互传（必通版）</title>
    <style>
        body { max-width: 500px; margin: 20px auto; padding: 0 15px; font-family: sans-serif; }
        .box { margin: 20px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        button { padding: 10px 20px; background: #2563EB; color: white; border: none; border-radius: 6px; cursor: pointer; }
        textarea { width: 100%; height: 120px; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; resize: none; box-sizing: border-box; }
        #deviceList { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .online-device { color: #059669; font-weight: 500; margin: 5px 0; }
        .status { margin: 10px 0; color: #666; }
    </style>
</head>
<body>
    <h1>同一WiFi文本互传</h1>

    <!-- 1. 设备发现 -->
    <div class="box">
        <h3>1. 发现同一WiFi设备</h3>
        <button id="scanBtn">开始扫描设备</button>
        <div id="deviceList">未扫描到设备</div>
        <div class="status">点击“开始扫描”后，等待1-2秒</div>
    </div>

    <!-- 2. 发送文本 -->
    <div class="box">
        <h3>2. 发送文本</h3>
        <textarea id="sendText" placeholder="输入要发送的内容..." disabled></textarea>
        <button id="sendBtn" disabled>发送给所有在线设备</button>
    </div>

    <!-- 3. 接收文本 -->
    <div class="box">
        <h3>3. 接收文本</h3>
        <textarea id="receiveText" readonly placeholder="等待接收内容..."></textarea>
        <button id="clearBtn">清空接收区</button>
    </div>

    <script>
        // 核心：用Broadcast Channel实现同一WiFi下设备广播通信（浏览器原生支持）
        let broadcastChan;
        let isScanning = false;
        let deviceId = 'dev_' + Math.random().toString(36).substr(2, 8); // 每台设备唯一ID

        // DOM元素
        const scanBtn = document.getElementById('scanBtn');
        const deviceList = document.getElementById('deviceList');
        const sendText = document.getElementById('sendText');
        const sendBtn = document.getElementById('sendBtn');
        const receiveText = document.getElementById('receiveText');
        const clearBtn = document.getElementById('clearBtn');

        // 1. 扫描设备：初始化广播通道
        scanBtn.addEventListener('click', () => {
            if (isScanning) return;
            isScanning = true;
            scanBtn.textContent = '正在扫描...';
            deviceList.innerHTML = '正在查找同一WiFi设备...';

            // 创建广播通道（同一WiFi下所有打开此页面的设备共用一个通道）
            broadcastChan = new BroadcastChannel('wifi_text_share');

            // 发送“设备上线”广播，让其他设备发现自己
            broadcastChan.postMessage({
                type: 'online',
                deviceId: deviceId,
                time: new Date().toLocaleTimeString()
            });

            // 监听其他设备的广播消息
            broadcastChan.onmessage = (e) => {
                const msg = e.data;
                handleBroadcastMsg(msg);
            };

            // 2秒后显示已发现的设备（给其他设备响应时间）
            setTimeout(() => {
                scanBtn.textContent = '重新扫描';
                isScanning = false;
                // 启用发送功能
                sendText.disabled = false;
                sendBtn.disabled = false;
            }, 2000);
        });

        // 处理广播消息（设备上线、接收文本）
        function handleBroadcastMsg(msg) {
            switch (msg.type) {
                // 其他设备上线：添加到设备列表
                case 'online':
                    if (msg.deviceId !== deviceId) { // 排除自己
                        const existingDevice = document.querySelector(`[data-id="${msg.deviceId}"]`);
                        if (!existingDevice) {
                            const deviceItem = document.createElement('div');
                            deviceItem.className = 'online-device';
                            deviceItem.dataset.id = msg.deviceId;
                            deviceItem.textContent = `✅ 设备${msg.deviceId.slice(-4)}（${msg.time}上线）`;
                            deviceList.appendChild(deviceItem);
                            // 首次发现设备时更新列表提示
                            if (deviceList.textContent.includes('正在查找')) {
                                deviceList.innerHTML = '';
                                deviceList.appendChild(deviceItem);
                            }
                        }
                    }
                    break;

                // 接收文本消息
                case 'text':
                    if (msg.deviceId !== deviceId) { // 只显示其他设备的消息
                        const time = new Date().toLocaleTimeString();
                        receiveText.value += `设备${msg.deviceId.slice(-4)}（${time}）：\n${msg.content}\n\n`;
                        receiveText.scrollTop = receiveText.scrollHeight;
                    }
                    break;
            }
        }

        // 3. 发送文本：广播给所有在线设备
        sendBtn.addEventListener('click', () => {
            const content = sendText.value.trim();
            if (!content) {
                alert('请输入要发送的内容');
                return;
            }

            // 发送文本广播
            broadcastChan.postMessage({
                type: 'text',
                deviceId: deviceId,
                content: content,
                time: new Date().toLocaleTimeString()
            });

            // 自己也显示发送的内容
            const time = new Date().toLocaleTimeString();
            receiveText.value += `我（${time}）：\n${content}\n\n`;
            receiveText.scrollTop = receiveText.scrollHeight;

            // 清空输入框
            sendText.value = '';
        });

        // 4. 清空接收区
        clearBtn.addEventListener('click', () => {
            receiveText.value = '';
        });

        // 页面关闭时发送“设备下线”广播
        window.addEventListener('beforeunload', () => {
            if (broadcastChan) {
                broadcastChan.postMessage({
                    type: 'offline',
                    deviceId: deviceId,
                    time: new Date().toLocaleTimeString()
                });
                broadcastChan.close();
            }
        });
    </script>
</body>
</html>
