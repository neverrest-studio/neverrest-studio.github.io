<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC 文本同步工具</title>
    <style>
        body { max-width: 500px; margin: 20px auto; padding: 0 20px; font-family: sans-serif; }
        .container { margin: 15px 0; }
        input, textarea, button { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; }
        #status { color: #666; font-size: 0.9em; margin-top: 10px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h3>WebRTC 跨设备文本同步</h3>
    <!-- 取件码匹配区 -->
    <div class="container">
        <label>取件码（两台设备需一致）：</label>
        <input type="text" id="code" placeholder="输入4位取件码" maxlength="4">
        <button onclick="initConnection()">开始连接</button>
    </div>

    <!-- 文本输入区 -->
    <div class="container">
        <label>输入文本：</label>
        <textarea id="sendText" rows="4" placeholder="输入要发送的内容..."></textarea>
        <button onclick="sendMessage()" disabled>发送文本</button>
    </div>

    <!-- 文本接收区 -->
    <div class="container">
        <label>接收的文本：</label>
        <textarea id="recvText" rows="4" readonly placeholder="等待接收内容..."></textarea>
        <div id="status">未连接，请输入取件码并点击「开始连接」</div>
    </div>

    <script>
        let peerConnection;
        const codeInput = document.getElementById('code');
        const sendText = document.getElementById('sendText');
        const recvText = document.getElementById('recvText');
        const status = document.getElementById('status');
        const sendBtn = document.querySelector('button[onclick="sendMessage()"]');

        // 初始化WebRTC连接
        function initConnection() {
            const code = codeInput.value.trim();
            if (!code) { 
                status.className = 'error';
                status.textContent = '❌ 请先输入取件码';
                return; 
            }

            // 配置WebRTC（无需服务器，仅本地网络）
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            peerConnection = new RTCPeerConnection(config);
            sendBtn.disabled = true;
            status.className = 'success';
            status.textContent = '🔍 正在同一网络搜索设备...';

            // 监听数据通道（接收方）
            peerConnection.ondatachannel = e => {
                const dataChannel = e.channel;
                dataChannel.onmessage = e => {
                    recvText.value = e.data;
                    status.textContent = `✅ 已接收文本（${new Date().toLocaleTimeString()}）`;
                };
                dataChannel.onopen = () => {
                    sendBtn.disabled = false;
                    status.textContent = '✅ 设备已连接，可发送文本';
                };
            };

            // 监听ICE候选（建立P2P连接）
            peerConnection.onicecandidate = e => {
                if (e.candidate) {
                    // 用取件码作为key，存储候选信息到localStorage（同一网络设备可读取）
                    localStorage.setItem(`webrtc_${code}`, JSON.stringify({
                        type: 'candidate',
                        data: e.candidate.toJSON()
                    }));
                }
            };

            // 主动创建数据通道（发送方）
            const dataChannel = peerConnection.createDataChannel('textSync');
            dataChannel.onopen = () => {
                sendBtn.disabled = false;
                status.textContent = '✅ 设备已连接，可发送文本';
            };
            dataChannel.onmessage = e => {
                recvText.value = e.data;
                status.textContent = `✅ 已接收文本（${new Date().toLocaleTimeString()}）`;
            };

            // 监听对方的连接请求（通过localStorage）
            setInterval(() => {
                const storedData = localStorage.getItem(`webrtc_${code}`);
                if (storedData) {
                    const { type, data } = JSON.parse(storedData);
                    if (type === 'offer') handleOffer(data);
                    if (type === 'candidate' && peerConnection) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(data))
                            .catch(err => console.error('添加候选失败:', err));
                    }
                }
            }, 1000);

            // 创建并发送连接请求（offer）
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    localStorage.setItem(`webrtc_${code}`, JSON.stringify({
                        type: 'offer',
                        data: peerConnection.localDescription.toJSON()
                    }));
                })
                .catch(err => {
                    status.className = 'error';
                    status.textContent = `❌ 连接失败：${err.message}`;
                });
        }

        // 处理对方的连接请求（offer）
        function handleOffer(offerData) {
            if (!peerConnection) return;
            peerConnection.setRemoteDescription(new RTCSessionDescription(offerData))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    localStorage.setItem(`webrtc_${codeInput.value}`, JSON.stringify({
                        type: 'answer',
                        data: peerConnection.localDescription.toJSON()
                    }));
                })
                .catch(err => console.error('处理offer失败:', err));
        }

        // 发送文本
        function sendMessage() {
            const text = sendText.value.trim();
            if (!text) return;
            const dataChannel = peerConnection.getSenders()[0].transport.datachannel;
            if (dataChannel.readyState === 'open') {
                dataChannel.send(text);
                sendText.value = '';
                status.textContent = `✅ 文本已发送（${new Date().toLocaleTimeString()}）`;
            }
        }
    </script>
</body>
</html>
